<!DOCTYPE html>

<html>
<head>
  <title>convert_namespace.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="auth.html">
                auth.js
              </a>
            
              
              <a class="source" href="auth_offline_backend.html">
                auth_offline_backend.js
              </a>
            
              
              <a class="source" href="upload_collection.html">
                upload_collection.js
              </a>
            
              
              <a class="source" href="configs.html">
                configs.js
              </a>
            
              
              <a class="source" href="convert_namespace.html">
                convert_namespace.js
              </a>
            
              
              <a class="source" href="denormalize.html">
                denormalize.js
              </a>
            
              
              <a class="source" href="indexeddb_backbone_config.html">
                indexeddb_backbone_config.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="main_test.html">
                main_test.js
              </a>
            
              
              <a class="source" href="user_model.html">
                user_model.js
              </a>
            
              
              <a class="source" href="offline_utils.html">
                offline_utils.js
              </a>
            
              
              <a class="source" href="online_utils.html">
                online_utils.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="test_login.html">
                test_login.js
              </a>
            
              
              <a class="source" href="user_initialize.html">
                user_initialize.js
              </a>
            
              
              <a class="source" href="app_layout.html">
                app_layout.js
              </a>
            
              
              <a class="source" href="dashboard.html">
                dashboard.js
              </a>
            
              
              <a class="source" href="form.html">
                form.js
              </a>
            
              
              <a class="source" href="form_controller.html">
                form_controller.js
              </a>
            
              
              <a class="source" href="full_download.html">
                full_download.js
              </a>
            
              
              <a class="source" href="incremental_download.html">
                incremental_download.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="login.html">
                login.js
              </a>
            
              
              <a class="source" href="notification.html">
                notification.js
              </a>
            
              
              <a class="source" href="status.html">
                status.js
              </a>
            
              
              <a class="source" href="upload.html">
                upload.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>convert_namespace.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This module converts an object of an entity from one namespace to another.
takes a denormalised object and the foreign entities description for the object. Using the descrip iterates over json,identifies the foreign values and substitute their online ids with offline ids or the opposite. 
Used by incremental_download, upload, form_controller.
To use - call the convert method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="string">'jquery'</span>, <span class="string">'configs'</span>, <span class="string">'backbone'</span>, <span class="string">'indexeddb_backbone_config'</span>

], <span class="keyword">function</span>($, configs, pa, indexeddb) {
    <span class="keyword">var</span> convert_namespace = {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>converts from offline to online by default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        which_to_which: <span class="string">"offlinetoonline"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>declared to make conversion code generic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        conv_dict: {
            <span class="string">"onlinetooffline"</span>: {
                replace_this: <span class="string">"online_id"</span>,
                replace_with: <span class="string">"id"</span>
            },
            <span class="string">"offlinetoonline"</span>: {
                replace_this: <span class="string">"id"</span>,
                replace_with: <span class="string">"online_id"</span>
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>returns the id_field declared in the foreign entity definition of this &#39;element&#39; in configs of &#39;entity&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get_id_field: <span class="keyword">function</span>(entity, element, f_entities) {
            <span class="keyword">return</span> f_entities[entity][element].id_field || <span class="string">"id"</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>recieves the object to be converted, conversion-way and the foreign entity definition of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        convert: <span class="keyword">function</span>(json, f_entities, which_to_which) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">if</span> (which_to_which)
                <span class="keyword">this</span>.which_to_which = which_to_which;
            <span class="keyword">var</span> that = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>making a deep copy of received object...this copy would be altered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> conv_json = $.extend(<span class="literal">true</span>, <span class="literal">null</span>, json);
            console.log(<span class="string">"FORMCONTROLLER:convert_namespace: json before converting"</span> + JSON.stringify(json));</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>is filled with a dfd for each foreign element to be converted - when all dfds resolve - conversion is complete</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.field_dfds = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>iterate over the foreign elements of the object and converts them asynchronously - fills the field_dfds with a dfd for each conversion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.iterate_foreign_fields(conv_json, f_entities);

            <span class="keyword">var</span> object_jsons = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>set the return object based on conversion-way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">switch</span> (<span class="keyword">this</span>.which_to_which) {
                <span class="keyword">case</span> <span class="string">"onlinetooffline"</span>:
                    object_jsons = {
                        off_json: conv_json,
                        on_json: json
                    }
                    <span class="keyword">break</span>;
                <span class="keyword">default</span>:
                    object_jsons = {
                        off_json: json,
                        on_json: conv_json
                    }
            }
            <span class="keyword">if</span> (<span class="keyword">this</span>.field_dfds.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>wait till all foreign elements resolve(all dfds in field_dfds resolve)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                $.when.apply($, <span class="keyword">this</span>.field_dfds)
                    .done(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>object successfully converted - return</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">return</span> dfd.resolve(object_jsons);
                    })
                    .fail(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>atleast one foreign element failed to be converted - abort and return</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">return</span> dfd.reject();
                    });
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>no conversion taking place - return immediately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                console.log(<span class="string">"FORMCONTROLLER:convert_namespace: Nothing to convert."</span>);
                <span class="keyword">return</span> dfd.resolve(object_jsons);
            }

            <span class="keyword">return</span> dfd.promise();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>iterates over the foreign elements of the object and converts them asynchronously - fills the field_dfds with a dfd for each conversion</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        iterate_foreign_fields: <span class="keyword">function</span>(json, f_entities) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>use the foreign entities definition of this object&#39;s entity to iterate over the foreign elements in the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> f_entities) {
                <span class="keyword">for</span> (<span class="keyword">var</span> element <span class="keyword">in</span> f_entities[entity]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>the foreign element doesn&#39;t exists in the object </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (!(json[element]))
                        <span class="keyword">continue</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p> get the name of the id_field of the foreign element - for eg - id or person_id </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> id_field = <span class="keyword">this</span>.get_id_field(entity, element, f_entities);
                    <span class="keyword">var</span> field_desc = {
                        entity_name: entity,
                        id_attribute: id_field
                    };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>foreign elements is a multi-select (dropdown or expanded)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (json[element] <span class="keyword">instanceof</span> Array)
                        _.each(json[element], <span class="keyword">function</span>(object, index) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>convert each value of this multi-select </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">this</span>.field_dfds.push(<span class="keyword">this</span>.convert_object(object, field_desc));
                        }, <span class="keyword">this</span>);
                    <span class="keyword">else</span> <span class="comment">//foreign elements is a single-select (dropdown)</span>
                        <span class="keyword">this</span>.field_dfds.push(<span class="keyword">this</span>.convert_object(json[element], field_desc));</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>if foreign element is an expanded and contains its own foreign elements - recursively iterate the expanded objects to convert their foreign elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (f_entities[entity][element].expanded)
                        <span class="keyword">if</span> (f_entities[entity][element].expanded.foreign_entities)
                            _.each(json[element], <span class="keyword">function</span>(object, index) {

                                <span class="keyword">this</span>.iterate_foreign_fields(object, f_entities[entity][element].expanded.foreign_entities);
                            }, <span class="keyword">this</span>);
                }
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>converts a single foreign element asynchronously and returns a dfd to wait upon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        convert_object: <span class="keyword">function</span>(obj, field_desc) {
            console.log(<span class="string">"ConvertNamespace: converting object"</span>, JSON.stringify(obj), JSON.stringify(field_desc));
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>the forein element is empty - return</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!obj[field_desc.id_attribute])
                <span class="keyword">return</span> dfd.resolve();</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p> fetch the foreign element from offline db<br>TODO:remove this and use the offline_utils module instead</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> generic_model_offline = Backbone.Model.extend({
                database: indexeddb,
                storeName: field_desc.entity_name,
            });
            <span class="keyword">var</span> f_model = <span class="keyword">new</span> generic_model_offline();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>the object is to be fetched based on &quot;id&quot; or &quot;online_id&quot; depending upon the conversion-way(on-to-off or off-to-on)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            f_model.set(<span class="keyword">this</span>.conv_dict[<span class="keyword">this</span>.which_to_which].replace_this, parseInt(obj[field_desc.id_attribute]));
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            f_model.fetch({
                success: <span class="keyword">function</span>(model) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>replace id with online_id or the opposite depending upon the conversion-way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    obj[field_desc.id_attribute] = model.get(that.conv_dict[that.which_to_which].replace_with);
                    <span class="keyword">return</span> dfd.resolve();
                },
                error: <span class="keyword">function</span>(model, error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>the foreign element object doesn&#39;t exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">return</span> dfd.reject(error);
                }
            });
            <span class="keyword">return</span> dfd.promise();
        }

    }


    <span class="keyword">return</span> convert_namespace;

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
