define(["require","framework/controllers/Controller","framework/globalEventManager","framework/ViewRenderer","framework/Util","jquery","app/libs/SearchFiltersDataFeed","text!app/views/collection-filter-list.html","text!app/views/collection-filter-breadcrumbs.html"],function(e){var t=e("framework/controllers/Controller"),n=e("framework/globalEventManager"),r=e("framework/ViewRenderer"),i=e("framework/Util"),s=e("jquery"),o=e("app/libs/SearchFiltersDataFeed"),u=e("text!app/views/collection-filter-list.html"),a=e("text!app/views/collection-filter-breadcrumbs.html"),f=t.extend({constructor:function(e){return this.base(e),this._fetchFilters(),this},_initReferences:function(e){this.base();var t=this._references;t.dataFeed=new o,t.filters_cleared=0,t.$filtersWrapper=e,t.$filtersContainer=e.find(".js-filters-container"),t.$filterBreadcrumbsContainer=s(".js-filter-breadcrumbs")},_initState:function(){this.base(),this._state.filterData={}},_initEvents:function(){this.base();var e=this._boundFunctions,t=this._references;e.onFilterCategoryLabelClick=this._onFilterCategoryLabelClick.bind(this),t.$filtersContainer.on("click",".js-filter-category-label",e.onFilterCategoryLabelClick),e.onFilterOptionClick=this._onFilterOptionClick.bind(this),t.$filtersContainer.on("click",".js-filter-option",e.onFilterOptionClick),e.onBreadcrumbsRemoveFilterClick=this._onBreadcrumbsRemoveFilterClick.bind(this),t.$filterBreadcrumbsContainer.on("click",".js-remove-filter",e.onBreadcrumbsRemoveFilterClick),e.onClearAllFiltersClick=this._onClearAllFiltersClick.bind(this),t.$filtersWrapper.on("click",".js-clear-all-filters",e.onClearAllFiltersClick)},_onFilterCategoryLabelClick:function(e){e.preventDefault();var t=this._state.filterData.categories,n=s(e.currentTarget).closest(".js-filter-category"),r=n.data("categoryId");if(t[r].categoryOpen){n.find(".js-subcategory-wrapper").stop(!0).animate({height:"0px"},1e3),n.removeClass("open");return}var i;for(i in t)t[i].categoryOpen=!1;var o=this._references.$filtersContainer.find(".js-filter-category").not(n);o.find(".js-subcategory-wrapper").stop(!0).animate({height:"0px"},1e3),o.removeClass("open"),t[r].categoryOpen=!0;var u=n.find(".js-subcategory-container");n.find(".js-subcategory-wrapper").stop(!0).animate({height:u.outerHeight()+"px"},1e3),n.addClass("open")},_onFilterOptionClick:function(e){e.preventDefault();var t=s(e.currentTarget),n=t.closest(".js-filter-category"),r=n.data("category-id"),i=t.data("option-id"),o=this._state.filterData,u=this._getFilterStatus(r,i),a=!u;this._setFilterStatus(r,i,a),this._renderFilters()},_onBreadcrumbsRemoveFilterClick:function(e){e.preventDefault(),this._references.filters_cleared=1;var t=s(e.currentTarget),n=t.data("categoryId"),r=t.data("optionId");this._setFilterStatus(n,r,!1),this._renderFilters()},_onClearAllFiltersClick:function(e){e.preventDefault(),this._clearFilters(),this._references.$filtersContainer.find(".js-filter-option.enabled").removeClass("enabled"),this._updateBreadcrumbs(),this.trigger("filtersCleared")},_indicateCurrentLanguageSelection:function(){var e=i.Cookie.get("language__name");if(!e)return;var t=this._state.filterData.categories.language;if(!t)return;try{var n=this._state.filterData.categories.language.options}catch(r){return}var s=0,o=n.length;for(;s<o;s++)if(n[s].value==e){this._setFilterStatus("language__name",s,!0);return}},_clearFilters:function(){var e=this._state.filterData;if(e.categories==undefined)return;var t=e.categories,n,r,i;for(n in t){var s=t[n],o=s.options;if(o==undefined)continue;r=0,i=o.length;for(;r<i;r++){var u=o[r];if(!u.filterActive)continue;u.filterActive=!1}}},updateTotalCount:function(e){this._state.totalCount=e,this._updateBreadcrumbs()},_updateBreadcrumbs:function(){var e=this._getActiveFilters(),t={totalCount:this._state.totalCount,activeFilters:e};r.renderHTML(this._references.$filterBreadcrumbsContainer,a,t)},_setFilterStatus:function(e,t,n){e=="language__name"&&(e="language");var r,i=this._state.filterData.categories[e],s;for(r=0;r<i.options.length;r++)i.options[r].title==t&&(s=this._state.filterData.categories[e].options[r]);if(s==undefined)return;s.filterActive=n,this._updateBreadcrumbs(),this.trigger("filterChanged",e,s.value,n)},_getFilterStatus:function(e,t){var n;for(n=0;n<this._state.filterData.categories[e].options.length;n++)if(this._state.filterData.categories[e].options[n].title==t)return this._state.filterData.categories[e].options[n].filterActive},_findFilterElementById:function(e,t){var n=this._references.$filtersContainer,r=n.find("[data-category-id="+e+"]"),i=r.find("[data-option-id="+t+"]");return i},_fetchFilters:function(){this._references.dataFeed.fetch(null,this._onDataProcessed.bind(this))},_onDataProcessed:function(){this._state.filterData=this._references.dataFeed.getSearchFilters(),this._renderFilters()},_getFilterDataForRender:function(){var e=this._state.filterData,t=[],n=this._getActiveFilters(),r=e.categories,s,o;for(s in r){var u=i.Object.clone(r[s],!0);u._categoryId=s;var a=u.options;for(o=0;o<a.length;o++){var f=a[o];if(f.dependencies){var l=this._checkFilterDependcies(f.dependencies);if(!l){a.splice(o,1),o--;continue}}u.options[o]._optionId=o}t.push(u)}var c={categories:t};return c},_checkFilterDependcies:function(e){return this._checkFilterAllOfDependencies(e.allOf)&&this._checkFilterOneOfDependencies(e.oneOf)},_checkFilterAllOfDependencies:function(e){if(e==undefined)return!0;var t=this._state.filterData.categories,n;for(n in e){if(!(n in t))return!1;var r=e[n],i=0,s=r.length;for(;i<s;i++){var o=r[i],u=t[n].options,a=!1,f=0,l=u.length;for(;f<l;f++){var c=u[f];if(o!=c.value)continue;if(!c.filterActive)return!1;a=!0;break}if(!a)return!1}}return!0},_checkFilterOneOfDependencies:function(e){if(e==undefined)return!0;var t=this._state.filterData.categories,n;for(n in e){if(!(n in t))return!1;var r=!1,i=e[n],s=0,o=i.length;for(;s<o;s++){var u=i[s],a=t[n].options,f=0,l=a.length;for(;f<l;f++){var c=a[f];if(u==c.value&&c.filterActive){r=!0;break}}if(r)break}if(!r)return!1}return!0},_renderFilters:function(){var e=this._getFilterDataForRender();r.renderHTML(this._references.$filtersContainer,u,e)},_getActiveFilters:function(){var e=[],t=this._state.filterData;if(t.categories==undefined)return[];var n=t.categories,r,i,s;for(r in n){var o=t.categories[r],u=o.options;if(u==undefined)continue;i=0,s=u.length;for(;i<s;i++){var a=u[i];if(!a.filterActive)continue;e.push({title:a.title,categoryId:r,optionId:i})}}return e},destroy:function(){this.base()}});return f});