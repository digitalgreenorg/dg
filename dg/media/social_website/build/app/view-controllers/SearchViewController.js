define(["require","framework/controllers/Controller","framework/ViewRenderer","framework/Util","jquery","app/libs/SearchCompletionsDataFeed","text!app/views/searchCompletion.html"],function(e){var t=e("framework/controllers/Controller"),n=e("framework/ViewRenderer"),r=e("framework/Util"),i=e("jquery"),s=e("app/libs/SearchCompletionsDataFeed"),o=e("text!app/views/searchCompletion.html"),u=t.extend({constructor:function(e){return this.base(e),this},_initConfig:function(){this.base(),this._config.searchInputChangeRefreshDelay=10},_initReferences:function(e){this.base();var t=this._references;t.dataFeed=new s,t.$searchWrapper=e,t.$searchInputBox=e.find("input#search"),t.$searchItemsContainer=e.find(".js-search-items-container")},_initState:function(){this.base();var e=this._state;e.maxCount=10,e.searchInputVal="",e.searchInputChangedTimeout=undefined},_initEvents:function(){this.base();var e=this._boundFunctions,t=this._references;e.preventDefaultStopPropagation=function(e){e.preventDefault(),e.stopPropagation()},t.$searchWrapper.on("click",e.preventDefaultStopPropagation),e.onDataProcessed=this._onDataProcessed.bind(this),t.dataFeed.on("dataProcessed",e.onDataProcessed),e.onKeyDown=this._onKeyDown.bind(this),t.$searchInputBox.keydown(e.onKeyDown),e.onKeyUp=this._onKeyUp.bind(this),t.$searchInputBox.keyup(e.onKeyUp),e.onSearchItemMouseEnter=this._onSearchItemMouseEnter.bind(this),t.$searchItemsContainer.on("mouseenter",".js-search-completion-item",e.onSearchItemMouseEnter),e.onSearchItemMouseClick=this._onSearchItemMouseClick.bind(this),t.$searchItemsContainer.on("click",".js-search-completion-item",e.onSearchItemMouseClick),e.onSearchInputChangedTimeout=this._onSearchInputChangedTimeout.bind(this),e.onBodyClick=this._onBodyClick.bind(this),i("body").on("click",e.onBodyClick)},setMaxCount:function(e){return this._state.maxCount=e,this},getMaxCount:function(){return this._state.maxCount},setSearchInputVal:function(e){return this._state.searchInputVal=e,this},getSearchInputVal:function(){return this._state.searchInputVal},getSearchItems:function(e,t){t==undefined?t=this.getMaxCount():this.setMaxCount(t);var n=this._references.dataFeed;n.setInputParam("searchString",e,!0),n.setInputParam("maxCount",t,!0);var r=n.getSearchItems();if(r==0)return!1;this._updateSearchDisplay(r)},_onDataProcessed:function(){this.getSearchItems()},_updateSearchDisplay:function(e){var t=[],n=0,r,i=e.length,s;for(;n<i;n++){s=undefined;for(r=0;r<t.length;r++)if(t[r].type==e[n].type){s=t[r];break}if(s==undefined){var s={type:e[n].type,items:[]};t.push(s)}s.items.push(e[n])}t.sort(function(e,t){return e.type>t.type});var o={categories:t};this._renderSearchItems(o)},_renderSearchItems:function(e){n.renderHTML(this._references.$searchItemsContainer,o,e)},_updateSelectedItem:function(e){var t=this._references.$searchItemsContainer.find(".js-search-completion-item"),n=t.filter(".hover"),i=t.index(n),s;i==-1?e==1&&(s=0):s=i+e,s=r.Math.mod(s,t.length),n.removeClass("hover"),t.eq(s).addClass("hover")},_selectItem:function(){var e=this._references.$searchItemsContainer.find(".js-search-completion-item.hover");if(e.length==0){var t=this._references.$searchWrapper.attr("data-url"),n=this._references.$searchInputBox.val();r=t+"?searchString="+n}else{var r=e.attr("href");if(!r)return}window.location.href=r},_onKeyDown:function(e){switch(e.keyCode){case 13:e.preventDefault(),this._selectItem();break;case 27:e.preventDefault(),this._clearSearchResults();break;case 38:e.preventDefault(),this._updateSelectedItem(-1);break;case 40:e.preventDefault(),this._updateSelectedItem(1)}},_onKeyUp:function(e){switch(e.keyCode){case 16:case 17:case 18:case 45:case 46:case 36:case 35:case 33:case 34:case 37:case 38:case 39:case 40:break;default:clearTimeout(this._state.searchInputChangedTimeout),this._state.searchInputChangedTimeout=setTimeout(this._boundFunctions.onSearchInputChangedTimeout,this._config.searchInputChangeRefreshDelay)}},_onSearchItemMouseClick:function(e){e.preventDefault(),this._selectItem()},_onSearchItemMouseEnter:function(e){this._references.$searchItemsContainer.find(".js-search-completion-item.hover").removeClass("hover");var t=i(e.currentTarget);t.addClass("hover")},_onBodyClick:function(e){this._clearSearchResults()},_clearSearchResults:function(){this._renderSearchItems([])},_onSearchInputChangedTimeout:function(){var e=this._references.$searchInputBox.val();e!=this.getSearchInputVal()&&(this.setSearchInputVal(e),this._references.dataFeed.clearSearchCompletionCache(),e==""?this._clearSearchResults():this.getSearchItems(e))},setInputParam:function(e,t,n){if(!this._references.dataFeed.setInputParam(e,t,n))return},destroy:function(){this.base()}});return u});