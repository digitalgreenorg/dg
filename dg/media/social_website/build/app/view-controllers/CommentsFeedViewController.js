define(["require","framework/controllers/Controller","framework/ViewRenderer","framework/Util","jquery","app/libs/CommentsDataFeed","text!app/views/comment.html"],function(e){var t=e("framework/controllers/Controller"),n=e("framework/ViewRenderer"),r=e("framework/Util"),i=e("jquery"),s=e("app/libs/CommentsDataFeed"),o=e("text!app/views/comment.html"),u=t.extend({constructor:function(e){return this.base(e),this},_initConfig:function(){this.base()},_initReferences:function(e){this.base();var t=this._references;t.dataFeed=new s,t.$commentsAreaWrapper=e,t.$commentsList=e.find(".js-comment-list"),t.$commentsFeedShowMoreButton=e.find(".js-comments-show-more-btn")},_initState:function(){this.base();var e=this._state;e.currentPageNumber=0,e.commentsPerPage=10,e.currentCount=0,e.commentAdded=!1},_initEvents:function(){this.base();var e=this._boundFunctions,t=this._references;e.onDataProcessed=this._onDataProcessed.bind(this),t.dataFeed.on("dataProcessed",e.onDataProcessed),e.onShowMoreClick=this._onShowMoreClick.bind(this),t.$commentsFeedShowMoreButton.on("click",e.onShowMoreClick),e.onToggleRepliesClick=this._onToggleRepliesClick.bind(this),t.$commentsList.on("click",".js-reply-visibility-toggle",e.onToggleRepliesClick)},setCommentsPerPage:function(e){return this._state.commentsPerPage=e,this},getCommentsPerPage:function(){return this._state.commentsPerPage},setCurrentPageNumber:function(e){return this._state.currentPageNumber=e,this},getCurrentPageNumber:function(){return this._state.currentPageNumber},getComments:function(e,t,n){e==undefined?e=this.getCurrentPageNumber():this.setCurrentPageNumber(e),t==undefined?t=this.getCommentsPerPage():this.setCommentsPerPage(t);var r=this._references.dataFeed;r.setInputParam("offset",e*t,!0),r.setInputParam("limit",t,!0);var i=r.getComments(),s=r.getTotalCount();if(i==0)return!1;this._updateCommentsFeedDisplay(i,s,n)},_onDataProcessed:function(){if(this._state.commentAdded==1){this.getComments(0,this._state.commentsPerPage,!0),this._state.commentAdded=!1;return}this.getComments()},_updateCommentsFeedDisplay:function(e,t,n){this._renderComments(e,n),n?this._onCommentsFeedUpdatedNewComment(t,e.length):this._onCommentsFeedUpdated(t,e.length)},_onCommentsFeedUpdated:function(e,t){this.updateTotalCount(e),this.addToCurrentCount(t),this.updateCommentsItemPaginationDisplay()},_onCommentsFeedUpdatedNewComment:function(e,t){this.updateTotalCount(e),this.updateCommentsItemPaginationDisplay()},_renderComments:function(e,t){var i=[],s=0,u=e.length,a,f;for(;s<u;s++){var l=r.Object.clone(e[s],!0),c=l.farmer;i.push(l)}var h={comments:i};t?n.renderHTML(this._references.$commentsList,o,h):n.renderAppend(this._references.$commentsList,o,h)},updateTotalCount:function(e){this._state.totalCount=e,i(".js-comment-count").html(r.integerCommaFormat(e))},addToCurrentCount:function(e){this._state.currentCount+=e},updateCommentsItemPaginationDisplay:function(){this._state.currentCount>=this._state.totalCount&&this._references.$commentsFeedShowMoreButton.hide()},_onShowMoreClick:function(e){e.preventDefault(),e.stopPropagation(),this.getComments(this.getCurrentPageNumber()+1)},_onToggleRepliesClick:function(e){e.preventDefault();var t=i(e.currentTarget).closest(".js-comment"),n=t.find(".js-reply-container");n.data("fullHeight")==undefined&&n.data("fullHeight",n.height()).css("height","0px").css("display","block"),n.hasClass("expanded")?n.stop(!0).animate({height:"0px"},1e3).removeClass("expanded"):n.stop(!0).animate({height:n.data("fullHeight")+"px"},1e3).addClass("expanded")},setInputParam:function(e,t,n){if(!this._references.dataFeed.setInputParam(e,t,n))return},afterCommentAdd:function(){this._state.commentAdded=!0,this._references.dataFeed.deleteInputParam("user"),this._references.dataFeed.deleteInputParam("text"),this.getComments()},addNewComment:function(e,t,n){this._references.dataFeed.addInputParam("video",!1,e),this._references.dataFeed.addInputParam("user",!1,t),this._references.dataFeed.addInputParam("text",!1,n),this._references.dataFeed.setInputParam("video",e,!0),this._references.dataFeed.setInputParam("user",t,!0),this._references.dataFeed.setInputParam("text",n,!0),this._references.dataFeed._fetch(null,this.afterCommentAdd.bind(this),"POST")},destroy:function(){this.base()}});return u});