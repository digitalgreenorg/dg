define(["require","framework/controllers/Controller","framework/ViewRenderer","framework/Util","jquery","text!app/views/collection-wrapper.html","text!app/views/collection.html","text!app/views/collection-video-drawer.html"],function(e){var t=e("framework/controllers/Controller"),n=e("framework/ViewRenderer"),r=e("framework/Util"),i=e("jquery"),s=e("text!app/views/collection-wrapper.html"),o=e("text!app/views/collection.html"),u=e("text!app/views/collection-video-drawer.html"),a=t.extend({constructor:function(e,t){return this.base(e,t),this},_initConfig:function(){this.base();var e=this._config;e.containerOpenHeight=213},_initReferences:function(e,t){this.base(e,t);var n=this._references;n.collectionsDataFeeds={},n.$collectionsWrapper=e},_initEvents:function(e){this.base(e);var t=this._references,n=this._boundFunctions,t=this._references;n.onCollectionItemClick=this._onCollectionItemClick.bind(this),t.$collectionsWrapper.on("click",".js-collection-item",n.onCollectionItemClick),n.totalNumberOfCollectionsReachedBinds={};var r,i;for(i in t.collectionsDataFeeds)r=this._onTotalNumberOfCollectionsReached.bind(this,i),n.totalNumberOfCollectionsReachedBinds[i]=r,t.collectionsDataFeeds[i].on("totalNumberOfCollectionsReached",r)},_initState:function(e){this.base(e);var t=this._state;t.collectionsPerRow=-1,t.collectionsPerPage=-1,t.videoDrawerClasses="",t.videosPerDrawer=-1},_addCollectionsDataFeed:function(e,t){this._references.collectionsDataFeeds[e]=t},_setCurrentCollectionsDataFeed:function(e){var t=this._references,n=t.collectionsDataFeeds[e];if(n==undefined)throw new Error('GenericCollectionsViewController._setCurrentCollectionsDataFeed(): no data feed found with id: "'+e+'"');t.currentCollectionsDataFeed=n},_getCurrentCollectionDataFeed:function(){var e=this._references.currentCollectionsDataFeed;if(e==undefined)throw new Error('GenericCollectionsViewController._getCurrentCollectionDataFeed(): no "currentCollectionsDataFeed" reference set');return e},_setAllCollectionsInputParam:function(e,t){var n=this._references.collectionsDataFeeds,r;for(r in n)n[r].setInputParam(e,t);return this},setCollectionsPerRow:function(e){return this._state.collectionsPerRow=e,this},setCollectionsPerPage:function(e){return this._state.collectionsPerPage=e,this},setVideoDrawerClasses:function(e){return this._state.videoDrawerClasses=e,this},setVideosPerDrawer:function(e){return this._state.videosPerDrawer=e,this},_setCollectionsPage:function(e){var t=this._getCurrentCollectionDataFeed();t.setCollectionsPage(e)},_getCollectionsPage:function(e){var t=this._getCurrentCollectionDataFeed(),n=t.getCollectionsPage(e,undefined,this._onCollectionsPageReceived.bind(this));return n},_onCollectionsPageReceived:function(e){var t=this._generateCollectionHTML(e);this._renderPartialCollections(t)},_getAllCurrentCollectionsPages:function(){var e=this._getCurrentCollectionDataFeed(),t=e.getAllCurrentCollectionsPages();return this._onAllCollectionsReceived(t),t},_onAllCollectionsReceived:function(e){var t=this._generateCollectionHTML(e);this._renderAllCollections(t)},_onTotalNumberOfCollectionsReached:function(e,t){},_onCollectionItemClick:function(e){var t=i(e.currentTarget),n=t.data("collectionItemIndex"),r=this._references.$collectionsWrapper.find(".js-video-container"),s=r.find(".js-video-drawer"),o,u=0,a=s.length;for(;u<a;u++){var f=s.eq(u);if(f.data("parentCollectionItemIndex")==n){o=f;break}}var l=o.closest(".js-video-container"),c=l.find(".js-video-drawer").not(o),h=l.hasClass("open");h||(this._openVideoDrawerContainers(l),this._closeVideoDrawerContainers(r.not(l))),this._showDrawers(o),this._hideDrawers(c);var p=l.find(".js-pointer"),d=t.offset().left,v=t.width(),m=o.offset().left,g=p.width(),y=20,b=d-m+v/2-g/2+y;h?p.animate({left:b+"px"}):p.css("left",b)},_openVideoDrawerContainers:function(e){e.stop(!0).animate({height:this._config.containerOpenHeight+"px"}).addClass("open")},_closeVideoDrawerContainers:function(e){e.stop(!0).animate({height:"0px"}).removeClass("open")},_showDrawers:function(e){e.css({position:"relative",visibility:"visible"})},_hideDrawers:function(e){e.css({position:"",visibility:""})},_generateCollectionHTML:function(e,t){var a=this._state,f=a.collectionsPerRow;if(f==undefined)throw new Error("GenericCollectionsViewController._generateCollectionHTML(): the number of collections per row is not set; call setCollectionsPerRow() prior to attempting to fetch data");var l=a.videoDrawerClasses,c=e.collections,h="",p="",d=[],v=0,m,g=c.length;for(;v<g;v++){var y=r.Object.clone(c[v],!0),b=e.startPage*e.countPerPage+v;y._index=b,y._collectionStats=this._getCollectionStats(y),y._plural=y.videos.length!=1,p+=n.render(o,y);for(m=0;m<y.videos.length;m++)y.videos[m]._time=r.secondsToHMSFormat(y.videos[m].duration);var w=this._prepareVideoDrawerData(y.videos);w._index=b,d.push(w);if((v+1)%f==0||v==g-1){p+=n.render(u,{_videoDrawerClasses:l,_videoDrawers:d});var E=i("<div />");E.html(s),E.find(".js-collections-page").html(p),h+=E.html(),d.splice(0),p=""}}return h},_getCollectionStats:function(e){var t=0,n=0,i=0,s=0,o=e.videos;if(!o)throw new Error("CollectionViewController._getCollectionStats(): trying to get collection stats on an object with no videos array");var u=0,a=o.length;for(;u<a;u++){var f=o[u];t+=f.duration,n+=f.adoptions,i+=f.offlineViews+f.onlineViews,s+=f.offlineLikes+f.onlineLikes}return{time:r.secondsToHMSFormat(t),adoptions:r.integerCommaFormat(n),views:r.integerCommaFormat(i),likes:r.integerCommaFormat(s)}},_prepareVideoDrawerData:function(e){var t=this._state.videosPerDrawer,n=[],r=0,i=e.length,s,o;for(;r<i;r+=t){o=[];for(s=0;s<t&&s+r<i;s++){var u=e[r+s];u._videoIndex=s+1,o.push(u)}n.push({videos:o})}return{carouselSlides:n}},_renderPartialCollections:function(e){throw new Error("GenericCollectionsViewController._renderPartialCollections(): abstract function not overridden or this.base() called")},_renderAllCollections:function(e){throw new Error("GenericCollectionsViewController._renderAllCollections(): abstract function not overridden or this.base() called")},destroy:function(){this.base()}});return a});