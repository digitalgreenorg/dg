<!DOCTYPE html>

<html>
<head>
  <title>form_controller.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="auth.html">
                auth.js
              </a>
            
              
              <a class="source" href="auth_offline_backend.html">
                auth_offline_backend.js
              </a>
            
              
              <a class="source" href="upload_collection.html">
                upload_collection.js
              </a>
            
              
              <a class="source" href="configs.html">
                configs.js
              </a>
            
              
              <a class="source" href="convert_namespace.html">
                convert_namespace.js
              </a>
            
              
              <a class="source" href="denormalize.html">
                denormalize.js
              </a>
            
              
              <a class="source" href="indexeddb_backbone_config.html">
                indexeddb_backbone_config.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="main_test.html">
                main_test.js
              </a>
            
              
              <a class="source" href="user_model.html">
                user_model.js
              </a>
            
              
              <a class="source" href="offline_utils.html">
                offline_utils.js
              </a>
            
              
              <a class="source" href="online_utils.html">
                online_utils.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="test_login.html">
                test_login.js
              </a>
            
              
              <a class="source" href="user_initialize.html">
                user_initialize.js
              </a>
            
              
              <a class="source" href="app_layout.html">
                app_layout.js
              </a>
            
              
              <a class="source" href="dashboard.html">
                dashboard.js
              </a>
            
              
              <a class="source" href="form.html">
                form.js
              </a>
            
              
              <a class="source" href="form_controller.html">
                form_controller.js
              </a>
            
              
              <a class="source" href="full_download.html">
                full_download.js
              </a>
            
              
              <a class="source" href="incremental_download.html">
                incremental_download.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="login.html">
                login.js
              </a>
            
              
              <a class="source" href="notification.html">
                notification.js
              </a>
            
              
              <a class="source" href="status.html">
                status.js
              </a>
            
              
              <a class="source" href="upload.html">
                upload.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>form_controller.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>This module is responsible for supporting Add/Edit functionalities. This is the container view of Form view for ADD/EDIT. Uses Form view to show the form. When Form has to be saved - gets the json from Form view and processes it to save the object depending upon the internet connectivity of the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([
    <span class="string">'jquery'</span>,
    <span class="string">'underscore'</span>,
    <span class="string">'layoutmanager'</span>,
    <span class="string">'views/notification'</span>,
    <span class="string">'indexeddb_backbone_config'</span>,
    <span class="string">'configs'</span>,
    <span class="string">'views/form'</span>,
    <span class="string">'collections/upload_collection'</span>,
    <span class="string">'convert_namespace'</span>,
    <span class="string">'offline_utils'</span>,
    <span class="string">'online_utils'</span>,
    <span class="string">'indexeddb-backbone'</span>
], <span class="keyword">function</span>(jquery, underscore, layoutmanager, notifs_view, indexeddb, configs, Form, upload_collection, ConvertNamespace, Offline, Online) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>FormController: Brings up the Add/Edit form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="comment">/*
    If we are saving offline - we set the json from the form, (we denormalize it), save it in the model and save the model in the upload queue.
    If we are saving online - we set the json from the form, (we denormalize it), we convert foreign keys ids to the online namespace, save the offline model, and then save it on server.
    If server save succeeds, then we set the online_id in the offline model.
    */</span>


    <span class="keyword">var</span> FormControllerView = Backbone.Layout.extend({

        initialize: <span class="keyword">function</span>(params) {
            console.log(<span class="string">"FORMCONTROLLER: initializing a new FormControllerView"</span>);
            <span class="keyword">this</span>.params = params;
            _.bindAll(<span class="keyword">this</span>);
        },
        template: <span class="string">"&lt;div&gt;&lt;div id = 'form'&gt;&lt;/div&gt;&lt;/div&gt;"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>setting up the form view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        beforeRender: <span class="keyword">function</span>() {
            console.log(<span class="keyword">this</span>.params);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>pass on the params to the form view - also add desired names of the buttons on form - null hides the button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.params = $.extend(<span class="keyword">this</span>.params, {
                serialize: {
                    button1: <span class="string">"Save and Add Another"</span>,
                    button2: <span class="literal">null</span>
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>initialize the form view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> form_v = <span class="keyword">new</span> Form(<span class="keyword">this</span>.params);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h1>form is the id of the element inside template where the form view will be inserted.</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.setView(<span class="string">"#form"</span>, form_v);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>listen to when form view sends these events 
this view now does nothing till these events are triggered by the form view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.listenTo(form_v, <span class="string">'save_clicked'</span>, <span class="keyword">this</span>.on_save);
            <span class="keyword">this</span>.listenTo(form_v, <span class="string">'button2_clicked'</span>, <span class="keyword">this</span>.on_button2);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Called when form view triggers save_clicked event(triggered after form has been converted to json, json has been cleaned and denormalised). 
Identifies type of final_json and saves it
After Save is finished calls an after_form_save function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        on_save: <span class="keyword">function</span>(e) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>event contains the form view object itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.form = e.context; 
            console.log(<span class="string">"FORMCONTROLLER: cleaned, denormalised json from form.js-"</span> + JSON.stringify(<span class="keyword">this</span>.form.final_json));
            <span class="keyword">var</span> that = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>stores dfds of all objects bieng saved in this form - form is completely saved when all dfd in this list are resolved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> save_complete_dfds = []; 

            <span class="keyword">if</span> (<span class="keyword">this</span>.form.bulk) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Save each object in bulk form individually</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                $.each(<span class="keyword">this</span>.form.final_json.bulk, <span class="keyword">function</span>(ind, obj) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>index is maintained in each object to find its location on the form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> bulk_index = obj.index;
                    <span class="keyword">delete</span> obj.index;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>save the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> save_object_dfd = that.save_object(obj, that.form.bulk.foreign_fields, that.form.entity_name);
                    save_object_dfd
                        .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>error while saving object
show the error on the form right above the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            that.form.show_errors(that.convert_to_row_error(error, that.form.entity_name, bulk_index));
                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>put dfd for this object-save in the save_complete_dfds list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    save_complete_dfds.push(save_object_dfd);
                });
            } 
            <span class="keyword">else</span> 
            {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>normal or inlines</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                
                <span class="keyword">if</span> (<span class="keyword">this</span>.form.inline) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>its an inline form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    console.log(<span class="string">"FORMCONTROLLER: separating inlines from final json"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>list of all inlines</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.inline_models = <span class="keyword">this</span>.form.final_json.inlines;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>separate inlines from final json - since they would be saved separately</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">delete</span> <span class="keyword">this</span>.form.final_json.inlines;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>add a dummy dfd for inlines - resolve it when inlines have been saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> inlines_dfd = <span class="keyword">new</span> $.Deferred();
                    save_complete_dfds.push(inlines_dfd);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>save the normal form object or the inline parent form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> save_object_dfd = <span class="keyword">this</span>.save_object(<span class="keyword">this</span>.form.final_json, <span class="keyword">this</span>.form.foreign_entities, <span class="keyword">this</span>.form.entity_name);
                save_object_dfd
                    .done(<span class="keyword">function</span>(off_json) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>parent form saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (that.form.inline)</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>If inline form - save inlines now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            that.save_inlines(that.inline_models, off_json, that.form.inline)
                                .done(<span class="keyword">function</span>(all_inlines) {
                                    console.log(<span class="string">"ALL INLINES SAVED"</span>);
                                    inlines_dfd.resolve(all_inlines);
                                })
                                .fail(<span class="keyword">function</span>() {
                                    console.log(<span class="string">"FAILED AT INLINES SAVE"</span>);
                                    show_inline_error();
                                    inlines_dfd.reject();
                                });
                    })
                    .fail(<span class="keyword">function</span>(error) {
                        that.form.show_errors(error);
                    });
                save_complete_dfds.push(save_object_dfd);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>When all objects in form are saved...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            $.when.apply(<span class="literal">null</span>, save_complete_dfds)
                .done(<span class="keyword">function</span>() {
                    console.log(<span class="string">"Everything saved"</span>);
                    that.after_form_save(that.form.entity_name);
                })
                .fail(<span class="keyword">function</span>() {
                    <span class="keyword">if</span> (that.form.bulk)
                        show_bulk_error();
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>shown if any inline could not be saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="keyword">function</span> <span class="title">show_inline_error</span><span class="params">()</span> {</span>
                <span class="keyword">var</span> err = {};
                err[that.form.entity_name] = {
                    __all__: [<span class="string">"Some "</span> + that.form.inline.entity + <span class="string">" (in red below) could not be saved. To correct errors and try saving them again - go to list page and edit this "</span> + that.form.entity_name]
                };
                that.form.show_errors(err, <span class="literal">true</span>);
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>shown if any bulk could not be saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="keyword">function</span> <span class="title">show_bulk_error</span><span class="params">()</span> {</span>
                <span class="keyword">var</span> err = {};
                err[that.form.entity_name] = {
                    __all__: [<span class="string">"Some "</span> + that.form.entity_name + <span class="string">" (in red below) could not be saved. To correct errors and try saving them again - open a new add form"</span>]
                };
                that.form.show_errors(err, <span class="literal">true</span>);
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>converts the error for an inline/bulk into a format which makes it show up at its own row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        convert_to_row_error: <span class="keyword">function</span>(error, row_entity_name, row_index) {
            error = $.parseJSON(error);
            error[<span class="string">"row"</span> + row_index] = error[row_entity_name];
            <span class="keyword">delete</span> error[row_entity_name];
            <span class="keyword">return</span> error;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>iterates over the inlines list and saves them serially</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        save_inlines: <span class="keyword">function</span>(inlines, parent_off_json, inline_config) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.complete_inlines(inlines, parent_off_json, inline_config);
            iterate_inlines();
            <span class="keyword">return</span> dfd;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>saves inlines serially    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="keyword">function</span> <span class="title">iterate_inlines</span><span class="params">()</span> {</span>
                <span class="keyword">if</span> (!inlines.length)
                    <span class="keyword">return</span> dfd.resolve();
                save_inline(inlines.shift())
                    .done(<span class="keyword">function</span>() {
                        iterate_inlines();
                    })
                    .fail(<span class="keyword">function</span>() {
                        dfd.reject();
                    });
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>saves an inline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="function"><span class="keyword">function</span> <span class="title">save_inline</span><span class="params">(inl)</span> {</span>
                <span class="keyword">var</span> inl_dfd = $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>index maintained to find its location on the form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> inl_index = inl.index;
                <span class="keyword">delete</span> inl.index;
                that.save_object(inl, inline_config.foreign_entities, inline_config.entity)
                    .fail(<span class="keyword">function</span>(error) {
                        that.form.show_errors(that.convert_to_row_error(error, inline_config.entity, inl_index));
                        <span class="keyword">return</span> inl_dfd.reject();
                    })
                    .done(<span class="keyword">function</span>() {
                        <span class="keyword">return</span> inl_dfd.resolve();
                    });
                <span class="keyword">return</span> inl_dfd.promise();
            };
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>put in the borrowed attributes and the joining attribute in inlines from the parent form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        complete_inlines: <span class="keyword">function</span>(inlines, parent_off_json, inline_config) {
            <span class="keyword">var</span> host_attr_json = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>get the host attr from parent object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            host_attr_json[inline_config.joining_attribute.inline_attribute] = {}
            _.each(inline_config.joining_attribute.host_attribute, <span class="keyword">function</span>(attr, index) {
                host_attr_json[inline_config.joining_attribute.inline_attribute][attr] = parent_off_json[attr];
            }, <span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>get the borrowed attrs from parent object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> borr_json = {}
            $.each(inline_config.borrow_attributes, <span class="keyword">function</span>(index, b_attr) {
                borr_json[b_attr.inline_attribute] = parent_off_json[b_attr.host_attribute];
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>substitute the host and borrowed attributes in each inline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            _.each(inlines, <span class="keyword">function</span>(inl, index) {
                console.log(<span class="string">"inl before extension - "</span> + JSON.stringify(inl));
                $.extend(<span class="literal">true</span>, inl, host_attr_json);
                $.extend(<span class="literal">true</span>, inl, borr_json);
                console.log(<span class="string">"inl after extension - "</span> + JSON.stringify(inl));
            });
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>save an object depending upon the internet connectivity of user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        save_object: <span class="keyword">function</span>(json, foreign_entities, entity_name) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">if</span> (<span class="keyword">this</span>.is_uploadqueue_empty() &amp;&amp; <span class="keyword">this</span>.is_internet_connected()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Online mode
convert namespace of object from offline to online</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                ConvertNamespace.convert(json, foreign_entities, <span class="string">"offlinetoonline"</span>)
                    .done(<span class="keyword">function</span>(on_off_jsons) {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>save in online mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        that.save_when_online(entity_name, on_off_jsons)
                            .done(<span class="keyword">function</span>(off_json) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>call any user defined after-save</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                call_after_save(off_json)
                                    .done(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>successfully saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        show_suc_notif();
                                        dfd.resolve(off_json);
                                    })
                                    .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>user defined after-save failed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        alert(<span class="string">"afterSave failed for entity - "</span> + entity_name + <span class="string">" - "</span> + error);
                                    });
                            })
                            .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>error saving the object
show error on form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                show_err_notif();
                                dfd.reject(error);
                            });
                    })
                    .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>namespace conversion failed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        show_err_notif();
                        <span class="keyword">return</span> dfd.reject(error);
                    });
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Offline mode
save in offline mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.save_when_offline(entity_name, json)
                    .done(<span class="keyword">function</span>(off_json) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>call any user defined after-save</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        call_after_save(off_json)
                            .done(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>successfully saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                show_suc_notif();
                                dfd.resolve(off_json);
                            })
                            .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>user defined after-save failed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                alert(<span class="string">"afterSave failed for entity - "</span> + entity_name + <span class="string">" - "</span> + error);
                            });
                    })
                    .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>error saving the object
show error on form</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        show_err_notif();
                        <span class="keyword">return</span> dfd.reject(error);
                    });
            }
            
            <span class="function"><span class="keyword">function</span> <span class="title">call_after_save</span><span class="params">(saved_off_json)</span> {</span>
                <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>get the user defined after-save for this entity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> afterSave = configs[entity_name].afterSave;
                <span class="keyword">if</span> (afterSave)
                    afterSave(saved_off_json, Offline)
                        .done(<span class="keyword">function</span>() {
                            dfd.resolve();
                        })
                        .fail(<span class="keyword">function</span>(error) {
                            dfd.reject(error);
                        });
                <span class="keyword">else</span> dfd.resolve();
                <span class="keyword">return</span> dfd.promise();
            };

            <span class="function"><span class="keyword">function</span> <span class="title">show_suc_notif</span><span class="params">()</span> {</span>
                notifs_view.add_alert({
                    notif_type: <span class="string">"success"</span>,
                    message: <span class="string">"Saved "</span> + entity_name
                });
            };

            <span class="function"><span class="keyword">function</span> <span class="title">show_err_notif</span><span class="params">()</span> {</span>
                notifs_view.add_alert({
                    notif_type: <span class="string">"error"</span>,
                    message: <span class="string">"Error saving "</span> + entity_name
                });
            };

            <span class="keyword">return</span> dfd.promise();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>saves the object in offline mode - in offline db and uploadQ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        save_when_offline: <span class="keyword">function</span>(entity_name, off_json) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">var</span> action, that = <span class="keyword">this</span>;
            <span class="keyword">if</span> (off_json.id)
                action = <span class="string">"E"</span>
            <span class="keyword">else</span>
                action = <span class="string">"A"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>save in offline db and then the uploadQ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Offline.save(<span class="literal">null</span>, entity_name, off_json)
                .done(<span class="keyword">function</span>(off_m) {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>succesfully saved in offline db</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    console.log(<span class="string">"SAVED IN OFFLINE - "</span> + JSON.stringify(off_m.toJSON()));
                    upload_collection.create({
                        data: off_m.toJSON(),
                        action: action,
                        entity_name: entity_name
                    }, {
                        success: <span class="keyword">function</span>(u_model) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>successfully saved in uploadQ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            console.log(<span class="string">"FORMCNTROLLER: model added to uploadqueue - "</span> + JSON.stringify(u_model.toJSON()));
                            <span class="keyword">return</span> dfd.resolve(off_m.toJSON());
                        },
                        error: <span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>failed to save in uploadQ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            alert(<span class="string">"Unexepected Error- error adding model to uploadqueue"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>TODO: Unexpected but should delete the model from offline db as well?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">return</span> dfd.reject(error);
                        }
                    });
                })
                .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>failed to save in offline db - return the error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">return</span> dfd.reject(error);
                });

            <span class="keyword">return</span> dfd.promise();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>saves the object in online mode - on the server and then the offline db</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        save_when_online: <span class="keyword">function</span>(entity_name, on_off_jsons) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">var</span> on_json = on_off_jsons.on_json;
            <span class="keyword">var</span> off_json = on_off_jsons.off_json
            console.log(<span class="string">"FORMCONTROLLER: Got this json to save online - "</span> + JSON.stringify(on_json));
            <span class="keyword">var</span> that = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>if edit case, substitute id with online id TODO: move it to convertnamespace?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (off_json.id) {
                on_json.id = parseInt(off_json.online_id);
                <span class="keyword">delete</span> on_json.online_id;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>save on server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Online.save(<span class="literal">null</span>, entity_name, on_json)
                .done(<span class="keyword">function</span>(on_m) {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>successfully saved on server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    console.log(<span class="string">"SAVED IN ONLINE - "</span> + JSON.stringify(on_m.toJSON()));</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>inject the online id returned by server in the offline object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    off_json.online_id = parseInt(on_m.get(<span class="string">"id"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>save offline object in offline db</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    Offline.save(<span class="literal">null</span>, entity_name, off_json)
                        .done(<span class="keyword">function</span>(off_m) {</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>successfully saved in offline and online</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            console.log(<span class="string">"SAVED IN OFFLINE - "</span> + JSON.stringify(off_m.toJSON()));
                            <span class="keyword">return</span> dfd.resolve(off_m.toJSON());
                        })
                        .fail(<span class="keyword">function</span>(error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>TODO: what to do abt the model just saved on server? </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">return</span> dfd.reject(error);
                        });
                })
                .fail(<span class="keyword">function</span>(xhr) {</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>failed to save on server - return the error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">return</span> dfd.reject(xhr.responseText);
                });
            <span class="keyword">return</span> dfd.promise();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>checks whether the uploadQ is empty or not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        is_uploadqueue_empty: <span class="keyword">function</span>() {
            console.log(<span class="string">"FORMCONTROLLER: length of upload_collection - "</span> + upload_collection.length);
            console.log(upload_collection);

            <span class="keyword">return</span> upload_collection.length &lt;= <span class="number">0</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>checks whther internet is available</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        is_internet_connected: <span class="keyword">function</span>() {
            <span class="keyword">return</span> navigator.onLine;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>button2 is made null - so this is nevr used </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        on_button2: <span class="keyword">function</span>(e) {
            console.log(<span class="string">"FORMCONTROLLER: Button 2 clicked on form"</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>route to a fresh add form for this entity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        after_form_save: <span class="keyword">function</span>(entity_name) {
            window.Router.navigate(entity_name + <span class="string">'/add'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>since may already be on the add page, therefore have to call this explicitly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            window.Router.add(entity_name); 
        }




    });</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Our module now returns our view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> FormControllerView;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
